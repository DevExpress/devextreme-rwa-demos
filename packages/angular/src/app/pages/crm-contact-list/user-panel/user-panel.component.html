<div class="panel" [ngClass]="{ pin: isPin, open: isOpen }">
  <div class="data-wrapper">
    <ng-container *ngIf="!isLoading">
      <div class="data-part">
        <dx-toolbar>
          <dxi-item location="before">
            <span class="contact-name value">{{ user.name }}</span>
          </dxi-item>
          <dxi-item location="before">
            <contact-status [value]="user.status"></contact-status>
          </dxi-item>
          <dxi-item location="after" [visible]="isPinEnabled">
            <dx-button
              [icon]="isPin ? 'unpin' : 'pin'"
              (onClick)="pinClick()"
            ></dx-button>
          </dxi-item>
          <dxi-item location="after">
            <dx-button icon="close" (onClick)="closePanel()"></dx-button>
          </dxi-item>
        </dx-toolbar>
      </div>

      <dx-scroll-view class="panel-scroll">
        <div class="data-part border form-compact">
          <dx-form [validationGroup]="validationGroup"
                   labelMode="floating"
                   [class.readonly]="!isEditing"
          >
            <dxi-item itemType="group" [colCount]="2" >
              <dxo-col-count-by-screen [xs]="2"></dxo-col-count-by-screen>
              <dxi-item cssClass="photo">
                <form-item-photo [link]="user.image"></form-item-photo>
              </dxi-item>

              <dxi-item itemType="group">
                <dxi-item cssClass="accent">
                  <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {label: 'Company', value: user.company}}"></ng-container>
                </dxi-item>

                <dxi-item>
                  <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {label: 'Position', value: user.position}}"></ng-container>
                </dxi-item>

                <dxi-item cssClass="accent">
                  <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {label: 'Assigned to', value: user.manager}}"></ng-container>
                </dxi-item>
              </dxi-item>
            </dxi-item>

            <dxi-item itemType="group">
              <dxi-item>
                <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {value: user.phone, icon: 'tel', mask: '+1(000)000-0000'}}"></ng-container>
              </dxi-item>
              <dxi-item>
                <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {value: user.email, icon: 'email', validators: [{type: 'email'}]}}"></ng-container>
              </dxi-item>
              <dxi-item>
                <ng-container *ngTemplateOutlet="fieldTpl;
                                context: {$implicit: {value: user.address, icon: 'home'}}"></ng-container>
              </dxi-item>
            </dxi-item>

            <ng-template #fieldTpl let-data>
              <dx-text-box [label]="data.label"
                           [(value)]="data.value"
                           [readOnly]="!isEditing"
                           [mask]="data.mask"
                           valueChangeEvent="keyup input change"
              >
                <dx-validator [validationRules]="data.validators || [{type: 'required'}]" [validationGroup]="validationGroup"></dx-validator>
                <dxi-button *ngIf="data.icon"
                            [options]="{icon: data.icon, type: 'back', elementAttr: { class: 'label-icon' }}"
                            name="icon"
                            location="before"
                ></dxi-button>
              </dx-text-box>
            </ng-template>

          </dx-form>
        </div>

        <div class="data-part data-part-toolbar border">
          <dx-toolbar class="panel-toolbar">
            <dxi-item location="before" [visible]="!isEditing">
              <dx-button
                text="Edit"
                icon="edit"
                stylingMode="outlined"
                type="default"
                (onClick)="toggleEdit()"
              ></dx-button>
            </dxi-item>
            <dxi-item location="before" [visible]="!isEditing">
              <dx-button
                text="Details"
                stylingMode="outlined"
                type="default"
                (onClick)="navigateToDetails()"
              ></dx-button>
            </dxi-item>
            <dxi-item
              location="before"
              locateInMenu="before"
              [visible]="isEditing"
            >
              <dx-button
                text="Save"
                icon="save"
                stylingMode="outlined"
                type="default"
                (onClick)="toggleEdit()"
              ></dx-button>
            </dxi-item>
            <dxi-item
              location="before"
              locateInMenu="before"
              [visible]="isEditing"
            >
              <dx-button
                text="Cancel"
                (onClick)="toggleEdit()"
                stylingMode="text"
              ></dx-button>
            </dxi-item>
            <dxi-item
              location="after"
              widget="dxDropDownButton"
              [options]="{
                width: 120,
                text: 'Actions',
                stylingMode: 'contained',
                items: ['Call', 'Send Fax', 'Send Email', 'Make a Meeting']
              }"
            ></dxi-item>
          </dx-toolbar>
        </div>

        <div class="data-part">
          <dx-accordion [multiple]="true" [collapsible]="true">
            <div class="accordion-title" *dxTemplate="let t of 'title'">
              <span>{{ t.title }}</span>
              <dx-button
                icon="add"
                type="default"
                stylingMode="text"
                (onClick)="accordionTitleClick($event)"
              ></dx-button>
            </div>

            <dxi-item title="Opportunities">
              <div *dxTemplate="let i of 'item'">
                <div
                  class="opportunities"
                  *ngFor="let opportunity of user.opportunities"
                >
                  <span class="value">{{ opportunity.name }} </span>
                  <br />
                  <span class="value black small">{{
                    opportunity.price | currency: "USD":"$":"1.0-0"
                  }}</span>
                  <br />
                </div>
              </div>
            </dxi-item>

            <dxi-item title="Activities">
              <card-activities [activities]="user.activities"></card-activities>
            </dxi-item>
          </dx-accordion>
        </div>
      </dx-scroll-view>
    </ng-container>

    <dx-load-panel
      [width]="300"
      [visible]="isLoading"
      [showPane]="false"
      container=".panel"
      [position]="{ of: '.panel' }"
    ></dx-load-panel>
  </div>
</div>
