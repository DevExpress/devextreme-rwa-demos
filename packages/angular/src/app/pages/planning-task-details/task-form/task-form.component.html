<div id="task-form" class="form-compact">
  <dx-toolbar>
    <dxi-item location="before"><span class="form-title">Details</span></dxi-item>
    <dxi-item location="after" locateInMenu="after" [visible]="!isEditing">
      <dx-button
        text="Edit"
        icon="edit"
        stylingMode="outlined"
        type="default"
        (onClick)="toggleEdit()"
      ></dx-button>
    </dxi-item>
    <dxi-item location="after" locateInMenu="after" [visible]="isEditing">
      <dx-button
        text="Save"
        stylingMode="outlined"
        type="default"
        (onClick)="toggleEdit()"
      ></dx-button>
    </dxi-item>
    <dxi-item location="after" locateInMenu="after" [visible]="isEditing">
      <dx-button
        text="Cancel"
        (onClick)="toggleEdit()"
        stylingMode="text"
      ></dx-button>
    </dxi-item>
  </dx-toolbar>

  <dx-form
    *ngIf="!isLoading"
    [formData]="task"
    labelMode="floating"
    [readOnly]="!isEditing"
  >
    <dxi-item itemType="group" [colCount]="2">
      <dxi-item cssClass="accent"
                dataField="company"
                [editorOptions]="editorOptions"
                template="itemPlain"
      ></dxi-item>
      <dxi-item cssClass="accent"
                dataField="owner"
                template="itemPlain"
      >
        <dxo-label text="Assigned to"></dxo-label>
      </dxi-item>
      <dxi-item
        dataField="priority"
        template="priorityField"
      ></dxi-item>
      <dxi-item
        dataField="status"
        template="statusField"
      ></dxi-item>
      <dxi-item
        dataField="startDate"
        editorType="dxDateBox"
        [template]="isEditing && !isEmptyStartDate ? null: 'startDate'"
        [editorOptions]="{
          name: 'Start Date',
          onValueChanged: startDateChange,
          placeholder: 'MM/dd/y',
          displayFormat: 'MM/dd/y',
          stylingMode: stylingMode
        }"
      ></dxi-item>
      <dxi-item
        dataField="dueDate"
        editorType="dxDateBox"
        [template]="isEditing && !isEmptyDueDate ? null: 'dueDate'"
        [editorOptions]="{
          name: 'Due Date',
          onValueChanged: dueDateChange,
          placeholder: 'MM/dd/y',
          displayFormat: 'MM/dd/y',
          stylingMode: stylingMode
        }"
      ></dxi-item>
    </dxi-item>

    <dxi-item
      [colSpan]="2"
      dataField="description"
      [template]="isEditing? null: 'itemPlain'"
      editorType="dxTextArea"
      [editorOptions]="editorOptions"
    >
      <dxo-label text="Details"></dxo-label>
    </dxi-item>

    <div *dxTemplate="let data of 'itemPlain'">
      <form-item-plain
        [isEditing]="isEditing"
        [label]="data.editorOptions.label"
        [(value)]="task[data.dataField]"
      ></form-item-plain>
    </div>

    <div *dxTemplate="let data of 'priorityField'">
      <form-item-plain
        [isEditing]="isEditing"
        [label]="data.editorOptions.label"
        [editorTpl]="priorityEditorTpl"
        [valueTpl]="priorityValueTpl"
      ></form-item-plain>

      <ng-template #priorityValueTpl>
        <task-priority [value]="task.priority"></task-priority>
      </ng-template>

      <ng-template #priorityEditorTpl>
        <dx-select-box
          [(value)]="task.priority"
          [items]="priorityList"
          [stylingMode]="stylingMode"
          [label]="data.editorOptions.label"
          fieldTemplate="field"
        >
          <div *dxTemplate="let data of 'field'">
            <div class="form-custom-list-prop">
              <task-priority [value]="task.priority"></task-priority>
              <dx-text-box [readOnly]="true"></dx-text-box>
            </div>
          </div>

          <div *dxTemplate="let data of 'item'">
            <task-priority [value]="data"></task-priority>
          </div>
        </dx-select-box>
      </ng-template>
    </div>

    <div *dxTemplate="let data of 'statusField'">
      <form-item-plain
        [isEditing]="isEditing"
        [label]="data.editorOptions.label"
        [editorTpl]="statusEditorTpl"
        [valueTpl]="statusValueTpl"
      ></form-item-plain>

      <ng-template #statusValueTpl>
        <task-status [value]="task.status"></task-status>
      </ng-template>

      <ng-template #statusEditorTpl>
        <dx-select-box
          [(value)]="task.status"
          [items]="statusList"
          [stylingMode]="stylingMode"
          [label]="data.editorOptions.label"
          [readOnly]="!isEditing"
          fieldTemplate="field"
        >
          <div *dxTemplate="let data of 'field'">
            <div class="form-custom-list-prop">
              <task-status [value]="task.status"></task-status>
              <dx-text-box [readOnly]="true"></dx-text-box>
            </div>
          </div>

          <div *dxTemplate="let data of 'item'">
            <task-status [value]="data"></task-status>
          </div>
        </dx-select-box>
      </ng-template>
    </div>

    <div *dxTemplate="let data of 'startDate'">
      <ng-container *ngIf="!isEmptyStartDate else startDateEmptyTpl">
        <form-item-plain
          [label]="data.editorOptions.label"
          [value]="task.startDate"
          [renderedValue]="task.startDate | date: 'MM/dd/yyyy'"
        ></form-item-plain>
      </ng-container>

      <ng-template #startDateEmptyTpl>
        <form-item-date
          text="Start Date"
          [(value)]="task.startDate"
          (valueChange)="startDateChange($event)"
        ></form-item-date>
      </ng-template>
    </div>

    <div *dxTemplate="let data of 'dueDate'">
      <ng-container *ngIf="!isEmptyDueDate else dueDateEmptyTpl">
        <form-item-plain
          [label]="data.editorOptions.label"
          [value]="task.dueDate"
          [renderedValue]="task.dueDate | date: 'MM/dd/yyyy'"
        ></form-item-plain>
      </ng-container>

      <ng-template #dueDateEmptyTpl>
        <form-item-date
          text="Set Due Date"
          [(value)]="task.dueDate"
          (valueChange)="dueDateChange($event)"
        ></form-item-date>
      </ng-template>
    </div>
  </dx-form>

  <dx-load-panel
    [visible]="isLoading"
    [showPane]="false"
    content="#task-form"
    [position]="{ of: '#task-form' }"
  ></dx-load-panel>
</div>
